---
title: "$N_{trade}$ report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
params:
  time_period: NA
  units: NA
  Nt_result: NA
  Nt_redist: NA
  data_redistribution: NA
  population_year: NA
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE,
                      fig.pos = 'h',
                      fig.align = 'center',
                      fig.height = 3,
                      fig.width = 4)
```

```{r}
#Available variables

time_period <- params$time_period
units <- params$units
Nt <- params$Nt_result
Nt_redist <- params$Nt_redist
data_redistribution <- params$data_redistribution
population_year <- params$population_year

```


# Introduction

This report details the results of the $N_{trade}$ analysis perdormed using 
the $N_{trade}$ Shiny app. Data were processed employing the *qPRAentry* package.

$N_{trade}$ is defined as the potentially infected/infested quantity of commodities 
imported by a country (e.g., an EU country) from other third-countries where 
the pest of interest is present. This application is meant to calculate $N_{trade}$ 
and redistribute the data into the countries considered.


### Calculation of $N_{trade}$

For a given EU country $i$, $N_{trade_i}$ is calculated taking into account the 
quantity of commodity imported by country $i$ from non-EU countries where the pest 
is present, and the internal trade of this commodity, i.e., export and import 
between country $i$ and other EU countries $j$, with $j \neq i$. Thus, $N_{trade_i}$ 
is approached as:

$$
N_{trade_i} = ExtraPest_i - ExtraPest_i \sum_{j \neq i} R_{ij} + \sum_{j \neq i} ExtraPest_j R_{ji},
$$

Where:

$ExtraPest_i$ and $ExtraPest_j$ are the quantity of commodity imported from 
non-EU countries where the pest is present by country $i$ and country $j$, respectively. 
$R_{ij}$ and $R_{ji}$ represent the proportion of commodity exported from $i$ 
to $j$ ($IntraExp_{ij}$), and from $j$ to $i$ ($IntraExp_{ji}$), respectively, 
out of the total available commodity in the exporter country. This total quantity 
is considered as the sum of the internal production of the country ($IP$) and 
the total quantity imported from non-EU countries ($ExtraTotal$), 
regardless of whether the pest is present. Thus, the ratios $R_{ij}$ and $R_{ji}$ 
are defined as: 

  $$R_{ij} = \frac{IntraExp_{ij}}{IP_i + ExtraTotal_i},$$ 
  $$R_{ji} = \frac{IntraExp_{ji}}{IP_j + ExtraTotal_j}.$$

Based on these ratios, the quantity of $ExtraPest_i$ re-exported from country $i$ 
to all countries $j$ is approximated by $ExtraPest_i \sum_{j \neq i} R_{ij}$, 
while the quantity of $ExtraPest_j$ re-exported from all countries $j$ to country 
$i$ is estimated as $\sum_{j \neq i} ExtraPest_j R_{ji}$.
  
When uploading the datasets to calculate $N_{trade}$, the selected unit was 
`r units`, while the selected time-period is as follows: `r time_period`.


### $N_{trade}$ results

Below, the $N_{trade}$ results are displayed in both tabular and map formats.
The map shows the median $N_{trade}$ values by country at the NUTS0 level.

```{r}

# Display the table
knitr::kable(Nt, caption = "$N_{trade}$ results by Country", digits = 2) 
# %>%
#   kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))


plot_countries(Nt, "NUTS0", "Median", title = bquote(N[trade] ~ " Median")) +
   xlim(-20, 40) + ylim(35,70) +
   theme_bw()+
   theme(
     plot.title = element_text(size = 14),
     legend.title = element_text(size = 12)
   )

```
Figure 1: Median $N_{trade}$ values by country at the NUTS0 level.


# $N_{trade}$ redistribution

### Redistribution to NUTS2

After calculating $N_{trade}$ at the country level (NUTS0), the next step involves 
redistributing these quantities to NUTS2 regions. 

```{r}

if(data_redistribution=="Population"){
  data_text <- "population data from Eurostat"
}else{
  data_text <- "user custom data"
}

```

For this analysis, $N_{trade}$ data were redistributed from NUTS0 to NUTS2 level 
proportionally to `r data_text`.

```{r}

# population year/s:
if(length(population_year)==1){
  population_year_text <- paste0("year for population data is ", population_year)
  }else{
  population_year_text <- paste0("years, for which the average population will be 
                                 used as the basis for redistribution, are: ", 
                                 paste0(population_year, collapse=", "))
}

```

The selected `r population_year_text`.

Below, the $N_{trade}$ redistribution results are displayed in map format. 
The table is available in the downloaded Ntrade_results20XX-XX-XX.zip folder.
The map shows the median $N_{trade}$ values by regions (NUTS2 level).

```{r}

plot_nuts(Nt_redist, "NUTS2", "Median", title = bquote(N[trade] ~ " Median")) +
   xlim(-20, 40) + ylim(35,70) +
   theme_bw()+
  theme(
     plot.title = element_text(size = 14),
     legend.title = element_text(size = 12)
   )
```
Figure 2: $N_{trade}$ values redistributed at the NUTS2 level.
