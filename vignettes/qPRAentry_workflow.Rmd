---
title: "qPRAentry workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{qPRAentry workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(qPRAentry)
```

# Introduction

`qPRAentry` is a package designed for the quantitative pest risk assessment (PRA) 
entry step, which is the initial phase of a PRA that evaluates the movement of a pest 
into an area.

Two examples of the process flow in the PRA entry step, and the application of the 
functions available in the `qPRAentry` package, are shown below. 
The example [A](#example-ISO) uses the functions applicable to any country in the 
world using ISO codes ([ISO 3166 Maintenance Agency](https://www.iso.org/iso-3166-country-codes.html)). 
The example [B](#example-NUTS) uses the functions designed for use with the NUTS code system 
([NUTS - Nomenclature of territorial units for statistics](https://ec.europa.eu/eurostat/web/nuts)).

In both cases, trade data are required for the commodity that is considered to be a 
potential pathway for the pest under assessment. The data required include:

  - Import of the commodity from third countries to the countries of interest in 
  the study, both the total quantity and the quantity imported from third countries 
  where the pest is known to be present. 
  - Trade of the commodity between the countries of interest.
  - Internal production of the commodity in the countries of interest.

# A. Example using ISO codes {#example-ISO}

## 1. Trade data preparation

### Structure of trade data

This example uses the simulated trade data for Northern American countries, which 
contains a list of data frames with the required data. These data use country identifiers 
by ISO 3166-1 (alpha-2) codes. Trade data are arranged in three-months time periods.

The `load_csv()` function included in the `qPRAentry` package can be used to import 
the data from CSV files.

```{r}
data("datatrade_NorthAm")
```

Total quantity of commodity imported from third countries. 
This data frame must contain the columns: **reporter** (importing countries, 
in this case by ISO codes), **partner** (exporting countries), **value** (quantity 
of commodity), and **time_period** (time period of the trade activity).

Using the example data, we select imports from all third countries (column partner):

```{r}
extra_total <- datatrade_NorthAm$extra_import
head(extra_total)
```

Quantity of commodity imported from third countries where the pest is present. 
This data frame must contain the columns: **reporter** (importing countries, in this 
case by ISO codes),  **partner** (exporting countries where the pest is present), 
**value** (quantity of commodity), and **time_period** (time period of the trade activity).

Here, we assume that the pest is present in countries "CNTR_1" and "CNTR_2":

```{r message=FALSE, warning=FALSE}
library(dplyr)
CNTR_pest <- c("CNTR_1", "CNTR_2")
extra_pest <- datatrade_NorthAm$extra_import %>% filter(partner%in%CNTR_pest)
head(extra_pest)
```

Quantity of commodity traded between countries of interest. This data frame must contain 
the columns: **reporter** (importing countries, in this case by ISO codes), **partner** 
(exporting countries, in this case by ISO codes), **value** (quantity of commodity), 
and **time_period** (time period of the trade activity):

```{r}
intra_trade  <- datatrade_NorthAm$intra_trade
head(intra_trade)
```

Quantity of commodity produced internally in each country of interest. This data frame 
must contain the columns: **reporter** (producing countries, in this case by ISO codes), 
**value** (quantity of commodity), and **time_period** (time period of production):

```{r}
internal_production  <- datatrade_NorthAm$internal_production
head(internal_production)
```

### Generation of the `TradeData` object from the above data frames

The `trade_data()` function assembles the trade data to generate a `TradeData` object 
needed to subsequently calculate the quantity of potentially infested/infected commodity 
coming into each country of interest.

Using the arguments `filter_IDs` and `filter_period` we can select the countries and 
time periods of interest, respectively. If nothing is specified in these arguments, 
by default all countries and time periods included in the data will be selected. 
For this example, the United States (US) and Canada (CA) are selected, and for the 
time periods January-March and April-June.

```{r}
trade_NorthAm <- trade_data(extra_total = extra_total,
                            extra_pest = extra_pest,
                            intra_trade = intra_trade,
                            internal_production = internal_production,
                            filter_IDs = c("US", "CA"),
                            filter_period = c("January-March", "April-June"))
```

See total trade:

```{r}
head(trade_NorthAm$total_trade)
```

See trade between countries:

```{r}
head(trade_NorthAm$intra_trade)
```

Below is an example of how to visualise data using ISO 3166-1 (alpha-2) country codes, displaying the total quantity of commodity available in each country. The `plot_countries()` function can be used to display other data organised by using ISO 3166-1 (alpha-2) country codes. This function allows to incorporate other utilities of the `ggplot2` package.

```{r}
library(ggplot2)
plot_countries(data = trade_NorthAm$total_trade,
               iso_col = "country_IDs", 
               values_col = "total_available") +
  xlim(-180,-20) + ylim(0,90)
```

## 2. Ntrade

### Calculation of the Ntrade for each time period

```{r}
ntrade_NorthAm <- ntrade(trade_data = trade_NorthAm)
head(ntrade_NorthAm)
```

### Ntrade summary for the time periods

```{r}
ntrade_NorthAm_summary <- ntrade(trade_data = trade_NorthAm,
                                 summarise_result = c("mean", "sd", 
                                                      "quantile(0.025)", 
                                                      "median",
                                                      "quantile(0.975)"))
head(ntrade_NorthAm_summary)
```


```{r}
plot_countries(data = ntrade_NorthAm_summary,
               iso_col = "country_IDs", 
               values_col = "median") +
  xlim(-180,-20) + ylim(0,90)
```


## 3. Ntrade redistribution

```{r}
# consumption data at sub-national level
redist_data <- datatrade_NorthAm$consumption_iso2

# Redistribution
data_redist <- redist_iso(data = ntrade_NorthAm_summary,
                          iso_col = "country_IDs",
                          values_col = "median",
                          redist_data = redist_data,
                          redist_iso_col = "iso_3166_2",
                          redist_values_col = "value")

head(data_redist)
```

Note: The `qPRAentry` package currently does not include a built-in function to plot data at subdivision level using ISO 3166-2 codes, although it is available using NUTS codes (see example [B](#example-NUTS)). However, users can easily combine the output with other packages, such as `rnaturalearth` and `ggplot2`, to create maps representing these data.

## 4. Pathway model

```{r}

# # Expression for the pathway model using 3 parameters
# eq <- "(1/P1)*P2*P3"
# # Distribution for each parameter
# parameters <- list(
#   P1 = list(dist = "beta", shape1 = 0.5, shape2 = 1),
#   P2 = list(dist = "gamma", shape = 1.5, scale = 100),
#   P3 = list(dist = "lnorm", mean = 5, sd = 2)
# )
# # Run pathway_model()
# res_pathway <- pathway_model(ntrade_data = df,
#                              IDs_col = "IDs",
#                              values_col = "ntrade_values",
#                              expression = eq,
#                              parameters = parameters,
#                              niter = 100)
# head(res_pathway)
# # summary of the total for all countries
# res_pathway[res_pathway$IDs == "Total",]
# # plot
# plot_countries(res_pathway, "IDs", "Median")
```

# B. Example using NUTS codes {#example-NUTS}

## 1. Trade data preparation

### Structure of trade data

This example uses the simulated trade data for EU countries, which contains a list 
of data frames with the required data. These data use country identifiers 
by NUTS codes. Trade data are arranged in annual periods for 2020 and 2021.

The `load_csv()` function included in the `qPRAentry` package can be used to import 
the data from CSV files.

```{r}
data("datatrade_EU")
```

Total quantity of commodity imported from third countries, i.e., non-EU countries. 
This data frame must contain the columns: **reporter** (importing countries, 
in this case by NUTS0 codes), **partner** (exporting countries), **value** (quantity 
of commodity), and **time_period** (time period of the trade activity).

Using the example data, we select coded as "Extra_Total" in the column partner:

```{r}
extra_total <- datatrade_EU$extra_import %>% filter(partner=="Extra_Total")
head(extra_total)
```

Quantity of commodity imported from third countries where the pest is present. 
This data frame must contain the columns: **reporter** (importing countries, in this 
case by NUTS0 codes),  **partner** (exporting countries where the pest is present), 
**value** (quantity of commodity), and **time_period** (time period of the trade activity).

Here, we assume that the pest is present in countries "CNTR_1", "CNTR_2", and 
"CNTR_3", i.e., those that are not coded as "Extra_Total" in the column partner:

```{r}
extra_pest <- datatrade_EU$extra_import %>% filter(partner!="Extra_Total")
head(extra_pest)
```

Quantity of commodity traded between EU countries. This data frame must contain 
the columns: **reporter** (importing countries, in this case by NUTS0 codes), **partner** 
(exporting countries, in this case by NUTS0 codes), **value** (quantity of commodity), 
and **time_period** (time period of the trade activity):

```{r}
intra_trade  <- datatrade_EU$intra_trade
head(intra_trade)
```

Quantity of commodity produced internally in each EU country of interest. This data frame 
must contain the columns: **reporter** (producing countries, in this case by NUTS0 codes), 
**value** (quantity of commodity), and **time_period** (time period of production):

```{r}
internal_production  <- datatrade_EU$internal_production
head(internal_production)
```

### Generation of the `TradeData` object from the above data frames

The `trade_data()` function assembles the trade data to generate a `TradeData` object 
needed to subsequently calculate the quantity of potentially infested/infected commodity 
coming into each EU country.

In this case nothing is specified for the arguments `filter_IDs` and `filter_period`, 
so all countries and time periods included in the data are considered.

```{r}
trade_EU <- trade_data(extra_total = extra_total,
                       extra_pest = extra_pest,
                       intra_trade = intra_trade,
                       internal_production = internal_production)
```

```{r}
# Plot the total available quantity of commodity available in each country
plot_countries(data = trade_EU$total_trade, 
               iso_col = "country_IDs", 
               values_col = "total_available") +
  xlim(-30,50) + ylim(25,70)
```


## 2. Ntrade


```{r}
# Ntrade mean and sd for the time periods
ntrade_EU <- ntrade(trade_data = trade_EU,
                    summarise_result = c("mean", "sd"))
```

```{r}
# Plot Ntrade mean
plot_countries(data = ntrade_EU, 
               iso_col="country_IDs", 
               values_col="mean") +
  xlim(-40,50) + ylim(25,70)
```


## 3. Ntrade redistribution

```{r}
# 
# #' ## Example of data redistribution to NUTS2 using population data
# data("datatrade_EU")
# # extract NUTS0 codes (country level)
# nuts0 <- unique(datatrade_EU$internal_production$reporter)
# # simulate values for each country
# nuts0_data <- data.frame(nuts0 = nuts0,
#                          values = abs(rnorm(length(nuts0), 30000, 10000)))
# 
# data_redist <- redist_nuts(data = nuts0_data,
#                            nuts_col = "nuts0",
#                            values_col = "values",
#                            to_nuts = 2,
#                            redist_data = "population",
#                            population_year = c(2017, 2018, 2019))
# head(data_redist)
# 
# # Plot
# plot_nuts(data = data_redist,
#           nuts_level = 2,
#           nuts_col = "NUTS2", 
#           values_col = "values")
# 
# ## Example of data redistribution of two value columns to NUTS1 using custom data
# nuts0_data$values2 <- abs(rnorm(length(nuts0), 2000, 500))
# # NUTS1 codes extracted from 'giscoR' package
# library(dplyr)
# library(giscoR)
# nuts1_data <- gisco_get_nuts(nuts_level=1) %>% 
#   select(NUTS_ID) %>% 
#   # simulate values for each NUTS1
#   mutate(values = abs(rnorm(nrow(.), 0, 1000)))
# 
# data_redist <- redist_nuts(data = nuts0_data,
#                            nuts_col = "nuts0",
#                            values_col = c("values", "values2"),
#                            to_nuts = 1,
#                            redist_data = nuts1_data,
#                            redist_nuts_col = "NUTS_ID",
#                            redist_values_col = "values")
# 
# head(data_redist)
# 
# # Plot
# plot_nuts(data = data_redist,
#           nuts_level = 1,
#           nuts_col = "NUTS1", 
#           values_col = "values2")
```


## 4. Pathway model

```{r}
# ## Example using Northern American countries and ntrade simulated data
# data("datatrade_NorthAm")
# # Extract country IDs and simulate ntrade data
# IDs <- datatrade_NorthAm$internal_production$reporter
# df <- data.frame(IDs = IDs,
#                  ntrade_values = abs(rnorm(length(IDs), 10000, 2000)))
# # Expression for the pathway model using 3 parameters
# eq <- "(1/P1)*P2*P3"
# # Distribution for each parameter
# parameters <- list(
#   P1 = list(dist = "beta", shape1 = 0.5, shape2 = 1),
#   P2 = list(dist = "gamma", shape = 1.5, scale = 100),
#   P3 = list(dist = "lnorm", mean = 5, sd = 2)
# )
# # Run pathway_model()
# res_pathway <- pathway_model(ntrade_data = df,
#                              IDs_col = "IDs",
#                              values_col = "ntrade_values",
#                              expression = eq,
#                              parameters = parameters,
#                              niter = 100)
# head(res_pathway)
# # summary of the total for all countries
# res_pathway[res_pathway$IDs == "Total",]
# # plot
# plot_countries(res_pathway, "IDs", "Median")
```